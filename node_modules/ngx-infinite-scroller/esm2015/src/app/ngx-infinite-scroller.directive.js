/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Directive, ElementRef, Input, Output, EventEmitter, Renderer2, } from '@angular/core';
import { Subject, zip, fromEvent } from 'rxjs';
import { tap, map, pairwise, takeWhile, skipWhile, debounceTime } from 'rxjs/operators';
import { DirectiveStateService } from './directive-state.service';
import { InitialScrollPosition } from './enum/initial-scroll-position-type.enum';
import { DirectiveContext } from './directive-context';
import { ScrollingToTop } from './scrolling-strategy/scrolling-to-top';
import { ScrollingToBottom } from './scrolling-strategy/scrolling-to-bottom';
import { ScrollingToBoth } from './scrolling-strategy/scrolling-to-both';
import { ScrollHeightListener } from './scroll-height-listener/scroll-height-listener';
export class NgxInfiniteScrollerDirective extends DirectiveContext {
    /**
     * @param {?} el
     * @param {?} renderer
     * @param {?} state
     */
    constructor(el, renderer, state) {
        super();
        this.el = el;
        this.renderer = renderer;
        this.state = state;
        this.strategy = 'scrollingToBottom';
        this.initialScrollPosition = InitialScrollPosition.DEFAULT;
        this.scrollbarAnimationInterval = 100;
        this.scrollDebounceTimeAfterScrollHeightChanged = 50;
        this.scrollDebounceTimeAfterDOMMutationOnInit = 1000;
        this.scrollUpPercentilePositionTrigger = 2;
        this.scrollDownPercentilePositionTrigger = 98;
        this.onScrollUp = new EventEmitter();
        this.onScrollDown = new EventEmitter();
        this.scrollHeightChanged = new Subject();
        this.domMutationEmitter = new Subject();
        this.state.setup({
            el: el,
            initMode: true,
            scrollStreamActive: true,
            previousScrollPositionpUpdated: false
        });
    }
    /**
     * @private
     * @return {?}
     */
    get scrollPairChanged() {
        if (this.scrollChanged) {
            return this.scrollChanged.pipe(takeWhile(() => this.state.scrollStreamActive), map((e) => {
                return (/** @type {?} */ ({
                    scrollHeight: e.target.scrollHeight,
                    scrollTop: e.target.scrollTop,
                    clientHeight: e.target.clientHeight,
                }));
            }), pairwise(), debounceTime(this.scrollbarAnimationInterval));
        }
    }
    /**
     * @private
     * @return {?}
     */
    get scrollDirectionChanged() {
        return this.scrollingStrategy.scrollDirectionChanged(this.scrollPairChanged);
    }
    /**
     * @private
     * @return {?}
     */
    get scrollRequestZoneChanged() {
        return this.scrollingStrategy.scrollRequestZoneChanged(this.scrollDirectionChanged).pipe(tap(() => {
            this.state.updatePreviousScrollTop();
            this.state.updatePreviousScrollHeight();
            this.state.previousScrollPositionpUpdated = false;
            this.scrollHeightListener.start();
        }));
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.useStrategy();
        this.useScrollHeightListener();
        this.registerScrollEventHandler();
        this.registerMutationObserver();
        this.registerInitialScrollPostionHandler();
        this.registerPreviousScrollPositionHandler();
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() {
        this.registerScrollSpy();
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.domMutationObserver.disconnect();
    }
    /**
     * @param {?} position
     * @return {?}
     */
    scrollTo(position) {
        this.state.scrollStreamActive = false;
        this.renderer.setProperty(this.el.nativeElement, 'scrollTop', position);
        this.state.scrollStreamActive = true;
    }
    /**
     * @return {?}
     */
    onScrollbarHeightChanged() {
        this.scrollHeightChanged.next();
    }
    /**
     * @private
     * @return {?}
     */
    registerScrollEventHandler() {
        this.scrollChanged = fromEvent(this.el.nativeElement, 'scroll');
    }
    /**
     * @private
     * @return {?}
     */
    registerMutationObserver() {
        this.domMutationObserver = new MutationObserver((mutations) => {
            this.domMutationEmitter.next(mutations);
        });
        /** @type {?} */
        const config = { attributes: true, childList: true, characterData: true };
        this.domMutationObserver.observe(this.el.nativeElement, config);
    }
    /**
     * @private
     * @return {?}
     */
    registerInitialScrollPostionHandler() {
        this.domMutationEmitter.pipe(takeWhile(() => this.state.initMode), debounceTime(this.scrollDebounceTimeAfterDOMMutationOnInit)).subscribe(() => {
            this.scrollingStrategy.setInitialScrollPosition();
            this.state.initMode = false;
        });
    }
    /**
     * @private
     * @return {?}
     */
    registerPreviousScrollPositionHandler() {
        zip(this.scrollRequestZoneChanged, this.scrollHeightChanged).pipe(skipWhile(() => this.state.initMode), debounceTime(this.scrollDebounceTimeAfterScrollHeightChanged)).subscribe(() => {
            this.scrollingStrategy.setPreviousScrollPosition();
            this.state.previousScrollPositionpUpdated = true;
        });
    }
    /**
     * @private
     * @return {?}
     */
    registerScrollSpy() {
        this.scrollRequestZoneChanged.subscribe(() => {
            this.scrollingStrategy.askForUpdate();
        });
    }
    /**
     * @private
     * @return {?}
     */
    useStrategy() {
        switch (this.strategy) {
            case 'scrollingToBoth':
                this.scrollingStrategy = new ScrollingToBoth(this, this.state);
                break;
            case 'scrollingToTop':
                this.scrollingStrategy = new ScrollingToTop(this, this.state);
                break;
            case 'scrollingToBottom':
            default:
                this.scrollingStrategy = new ScrollingToBottom(this, this.state);
                break;
        }
    }
    /**
     * @private
     * @return {?}
     */
    useScrollHeightListener() {
        this.scrollHeightListener = new ScrollHeightListener(this, this.state);
    }
}
NgxInfiniteScrollerDirective.decorators = [
    { type: Directive, args: [{
                selector: '[ngxInfiniteScroller]'
            },] }
];
/** @nocollapse */
NgxInfiniteScrollerDirective.ctorParameters = () => [
    { type: ElementRef },
    { type: Renderer2 },
    { type: DirectiveStateService }
];
NgxInfiniteScrollerDirective.propDecorators = {
    strategy: [{ type: Input }],
    initialScrollPosition: [{ type: Input }],
    scrollbarAnimationInterval: [{ type: Input }],
    scrollDebounceTimeAfterScrollHeightChanged: [{ type: Input }],
    scrollDebounceTimeAfterDOMMutationOnInit: [{ type: Input }],
    scrollUpPercentilePositionTrigger: [{ type: Input }],
    scrollDownPercentilePositionTrigger: [{ type: Input }],
    onScrollUp: [{ type: Output }],
    onScrollDown: [{ type: Output }]
};
if (false) {
    /** @type {?} */
    NgxInfiniteScrollerDirective.prototype.strategy;
    /** @type {?} */
    NgxInfiniteScrollerDirective.prototype.initialScrollPosition;
    /** @type {?} */
    NgxInfiniteScrollerDirective.prototype.scrollbarAnimationInterval;
    /** @type {?} */
    NgxInfiniteScrollerDirective.prototype.scrollDebounceTimeAfterScrollHeightChanged;
    /** @type {?} */
    NgxInfiniteScrollerDirective.prototype.scrollDebounceTimeAfterDOMMutationOnInit;
    /** @type {?} */
    NgxInfiniteScrollerDirective.prototype.scrollUpPercentilePositionTrigger;
    /** @type {?} */
    NgxInfiniteScrollerDirective.prototype.scrollDownPercentilePositionTrigger;
    /** @type {?} */
    NgxInfiniteScrollerDirective.prototype.onScrollUp;
    /** @type {?} */
    NgxInfiniteScrollerDirective.prototype.onScrollDown;
    /**
     * @type {?}
     * @private
     */
    NgxInfiniteScrollerDirective.prototype.scrollHeightListener;
    /**
     * @type {?}
     * @private
     */
    NgxInfiniteScrollerDirective.prototype.scrollHeightChanged;
    /**
     * @type {?}
     * @private
     */
    NgxInfiniteScrollerDirective.prototype.domMutationObserver;
    /**
     * @type {?}
     * @private
     */
    NgxInfiniteScrollerDirective.prototype.domMutationEmitter;
    /**
     * @type {?}
     * @private
     */
    NgxInfiniteScrollerDirective.prototype.scrollChanged;
    /**
     * @type {?}
     * @private
     */
    NgxInfiniteScrollerDirective.prototype.el;
    /**
     * @type {?}
     * @private
     */
    NgxInfiniteScrollerDirective.prototype.renderer;
    /**
     * @type {?}
     * @private
     */
    NgxInfiniteScrollerDirective.prototype.state;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LWluZmluaXRlLXNjcm9sbGVyLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25neC1pbmZpbml0ZS1zY3JvbGxlci8iLCJzb3VyY2VzIjpbInNyYy9hcHAvbmd4LWluZmluaXRlLXNjcm9sbGVyLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUNMLFNBQVMsRUFJVCxVQUFVLEVBQ1YsS0FBSyxFQUNMLE1BQU0sRUFDTixZQUFZLEVBQ1osU0FBUyxHQUNWLE1BQU0sZUFBZSxDQUFDO0FBRXZCLE9BQU8sRUFBYyxPQUFPLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUUzRCxPQUFPLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUV4RixPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUdsRSxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSwwQ0FBMEMsQ0FBQztBQUVqRixPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN2RCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sdUNBQXVDLENBQUM7QUFDdkUsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sMENBQTBDLENBQUM7QUFDN0UsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHdDQUF3QyxDQUFDO0FBRXpFLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLGlEQUFpRCxDQUFDO0FBS3ZGLE1BQU0sT0FBTyw0QkFDWCxTQUFRLGdCQUFnQjs7Ozs7O0lBd0V4QixZQUNVLEVBQWMsRUFDZCxRQUFtQixFQUNuQixLQUE0QjtRQUVwQyxLQUFLLEVBQUUsQ0FBQztRQUpBLE9BQUUsR0FBRixFQUFFLENBQVk7UUFDZCxhQUFRLEdBQVIsUUFBUSxDQUFXO1FBQ25CLFVBQUss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QUFJLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUNqRSxNQUFNO1NBQ1Q7SUFDSCxDQUFDOzs7OztJQUVPLHVCQUF1QjtRQUM3QixJQUFJLENBQUMsb0JBQW9CLEdBQUcsSUFBSSxvQkFBb0IsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3pFLENBQUM7OztZQWpMRixTQUFTLFNBQUM7Z0JBQ1QsUUFBUSxFQUFFLHVCQUF1QjthQUNsQzs7OztZQXpCQyxVQUFVO1lBSVYsU0FBUztZQU9GLHFCQUFxQjs7O3VCQW1CM0IsS0FBSztvQ0FHTCxLQUFLO3lDQUdMLEtBQUs7eURBR0wsS0FBSzt1REFHTCxLQUFLO2dEQUdMLEtBQUs7a0RBR0wsS0FBSzt5QkFHTCxNQUFNOzJCQUdOLE1BQU07Ozs7SUF4QlAsZ0RBQzhDOztJQUU5Qyw2REFDNkY7O0lBRTdGLGtFQUN3Qzs7SUFFeEMsa0ZBQ3VEOztJQUV2RCxnRkFDdUQ7O0lBRXZELHlFQUM2Qzs7SUFFN0MsMkVBQ2dEOztJQUVoRCxrREFDaUU7O0lBRWpFLG9EQUNtRTs7Ozs7SUFFbkUsNERBQW1EOzs7OztJQUVuRCwyREFBaUU7Ozs7O0lBRWpFLDJEQUE4Qzs7Ozs7SUFFOUMsMERBQXdGOzs7OztJQUV4RixxREFBeUM7Ozs7O0lBbUN2QywwQ0FBc0I7Ozs7O0lBQ3RCLGdEQUEyQjs7Ozs7SUFDM0IsNkNBQW9DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcclxuICBEaXJlY3RpdmUsXHJcbiAgT25EZXN0cm95LFxyXG4gIE9uSW5pdCxcclxuICBBZnRlclZpZXdJbml0LFxyXG4gIEVsZW1lbnRSZWYsXHJcbiAgSW5wdXQsXHJcbiAgT3V0cHV0LFxyXG4gIEV2ZW50RW1pdHRlcixcclxuICBSZW5kZXJlcjIsXHJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcblxyXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJqZWN0LCB6aXAsIGZyb21FdmVudCB9IGZyb20gJ3J4anMnO1xyXG5cclxuaW1wb3J0IHsgdGFwLCBtYXAsIHBhaXJ3aXNlLCB0YWtlV2hpbGUsIHNraXBXaGlsZSwgZGVib3VuY2VUaW1lIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5cclxuaW1wb3J0IHsgRGlyZWN0aXZlU3RhdGVTZXJ2aWNlIH0gZnJvbSAnLi9kaXJlY3RpdmUtc3RhdGUuc2VydmljZSc7XHJcblxyXG5pbXBvcnQgeyBTY3JvbGxQb3NpdGlvbiB9IGZyb20gJy4vbW9kZWwvc2Nyb2xsLXBvc2l0aW9uLm1vZGVsJztcclxuaW1wb3J0IHsgSW5pdGlhbFNjcm9sbFBvc2l0aW9uIH0gZnJvbSAnLi9lbnVtL2luaXRpYWwtc2Nyb2xsLXBvc2l0aW9uLXR5cGUuZW51bSc7XHJcblxyXG5pbXBvcnQgeyBEaXJlY3RpdmVDb250ZXh0IH0gZnJvbSAnLi9kaXJlY3RpdmUtY29udGV4dCc7XHJcbmltcG9ydCB7IFNjcm9sbGluZ1RvVG9wIH0gZnJvbSAnLi9zY3JvbGxpbmctc3RyYXRlZ3kvc2Nyb2xsaW5nLXRvLXRvcCc7XHJcbmltcG9ydCB7IFNjcm9sbGluZ1RvQm90dG9tIH0gZnJvbSAnLi9zY3JvbGxpbmctc3RyYXRlZ3kvc2Nyb2xsaW5nLXRvLWJvdHRvbSc7XHJcbmltcG9ydCB7IFNjcm9sbGluZ1RvQm90aCB9IGZyb20gJy4vc2Nyb2xsaW5nLXN0cmF0ZWd5L3Njcm9sbGluZy10by1ib3RoJztcclxuXHJcbmltcG9ydCB7IFNjcm9sbEhlaWdodExpc3RlbmVyIH0gZnJvbSAnLi9zY3JvbGwtaGVpZ2h0LWxpc3RlbmVyL3Njcm9sbC1oZWlnaHQtbGlzdGVuZXInO1xyXG5cclxuQERpcmVjdGl2ZSh7XHJcbiAgc2VsZWN0b3I6ICdbbmd4SW5maW5pdGVTY3JvbGxlcl0nXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBOZ3hJbmZpbml0ZVNjcm9sbGVyRGlyZWN0aXZlXHJcbiAgZXh0ZW5kcyBEaXJlY3RpdmVDb250ZXh0XHJcbiAgaW1wbGVtZW50cyBPbkluaXQsIEFmdGVyVmlld0luaXQsIE9uRGVzdHJveSB7XHJcblxyXG4gIEBJbnB1dCgpXHJcbiAgcHVibGljIHN0cmF0ZWd5OiBzdHJpbmcgPSAnc2Nyb2xsaW5nVG9Cb3R0b20nO1xyXG5cclxuICBASW5wdXQoKVxyXG4gIHB1YmxpYyBpbml0aWFsU2Nyb2xsUG9zaXRpb246IEluaXRpYWxTY3JvbGxQb3NpdGlvbiB8IG51bWJlciA9IEluaXRpYWxTY3JvbGxQb3NpdGlvbi5ERUZBVUxUO1xyXG5cclxuICBASW5wdXQoKVxyXG4gIHB1YmxpYyBzY3JvbGxiYXJBbmltYXRpb25JbnRlcnZhbCA9IDEwMDtcclxuXHJcbiAgQElucHV0KClcclxuICBwdWJsaWMgc2Nyb2xsRGVib3VuY2VUaW1lQWZ0ZXJTY3JvbGxIZWlnaHRDaGFuZ2VkID0gNTA7XHJcblxyXG4gIEBJbnB1dCgpXHJcbiAgcHVibGljIHNjcm9sbERlYm91bmNlVGltZUFmdGVyRE9NTXV0YXRpb25PbkluaXQgPSAxMDAwO1xyXG5cclxuICBASW5wdXQoKVxyXG4gIHB1YmxpYyBzY3JvbGxVcFBlcmNlbnRpbGVQb3NpdGlvblRyaWdnZXIgPSAyO1xyXG5cclxuICBASW5wdXQoKVxyXG4gIHB1YmxpYyBzY3JvbGxEb3duUGVyY2VudGlsZVBvc2l0aW9uVHJpZ2dlciA9IDk4O1xyXG5cclxuICBAT3V0cHV0KClcclxuICBwdWJsaWMgb25TY3JvbGxVcDogRXZlbnRFbWl0dGVyPG51bGw+ID0gbmV3IEV2ZW50RW1pdHRlcjxudWxsPigpO1xyXG5cclxuICBAT3V0cHV0KClcclxuICBwdWJsaWMgb25TY3JvbGxEb3duOiBFdmVudEVtaXR0ZXI8bnVsbD4gPSBuZXcgRXZlbnRFbWl0dGVyPG51bGw+KCk7XHJcblxyXG4gIHByaXZhdGUgc2Nyb2xsSGVpZ2h0TGlzdGVuZXI6IFNjcm9sbEhlaWdodExpc3RlbmVyO1xyXG5cclxuICBwcml2YXRlIHNjcm9sbEhlaWdodENoYW5nZWQ6IFN1YmplY3Q8bnVsbD4gPSBuZXcgU3ViamVjdDxudWxsPigpO1xyXG5cclxuICBwcml2YXRlIGRvbU11dGF0aW9uT2JzZXJ2ZXI6IE11dGF0aW9uT2JzZXJ2ZXI7XHJcblxyXG4gIHByaXZhdGUgZG9tTXV0YXRpb25FbWl0dGVyOiBTdWJqZWN0PE11dGF0aW9uUmVjb3JkW10+ID0gbmV3IFN1YmplY3Q8TXV0YXRpb25SZWNvcmRbXT4oKTtcclxuXHJcbiAgcHJpdmF0ZSBzY3JvbGxDaGFuZ2VkOiBPYnNlcnZhYmxlPEV2ZW50PjtcclxuXHJcbiAgcHJpdmF0ZSBnZXQgc2Nyb2xsUGFpckNoYW5nZWQoKTogT2JzZXJ2YWJsZTxTY3JvbGxQb3NpdGlvbltdPiB7XHJcbiAgICBpZiAodGhpcy5zY3JvbGxDaGFuZ2VkKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLnNjcm9sbENoYW5nZWQucGlwZShcclxuICAgICAgICB0YWtlV2hpbGUoKCkgPT4gdGhpcy5zdGF0ZS5zY3JvbGxTdHJlYW1BY3RpdmUpLFxyXG4gICAgICAgIG1hcCgoZTogYW55KSA9PiB7XHJcbiAgICAgICAgICByZXR1cm4gPFNjcm9sbFBvc2l0aW9uPntcclxuICAgICAgICAgICAgc2Nyb2xsSGVpZ2h0OiBlLnRhcmdldC5zY3JvbGxIZWlnaHQsXHJcbiAgICAgICAgICAgIHNjcm9sbFRvcDogZS50YXJnZXQuc2Nyb2xsVG9wLFxyXG4gICAgICAgICAgICBjbGllbnRIZWlnaHQ6IGUudGFyZ2V0LmNsaWVudEhlaWdodCxcclxuICAgICAgICAgIH07XHJcbiAgICAgICAgfSksXHJcbiAgICAgICAgcGFpcndpc2UoKSxcclxuICAgICAgICBkZWJvdW5jZVRpbWUodGhpcy5zY3JvbGxiYXJBbmltYXRpb25JbnRlcnZhbClcclxuICAgICAgKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0IHNjcm9sbERpcmVjdGlvbkNoYW5nZWQoKTogT2JzZXJ2YWJsZTxTY3JvbGxQb3NpdGlvbltdPiB7XHJcbiAgICByZXR1cm4gdGhpcy5zY3JvbGxpbmdTdHJhdGVneS5zY3JvbGxEaXJlY3Rpb25DaGFuZ2VkKHRoaXMuc2Nyb2xsUGFpckNoYW5nZWQpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXQgc2Nyb2xsUmVxdWVzdFpvbmVDaGFuZ2VkKCk6IE9ic2VydmFibGU8U2Nyb2xsUG9zaXRpb25bXT4ge1xyXG4gICAgcmV0dXJuIHRoaXMuc2Nyb2xsaW5nU3RyYXRlZ3kuc2Nyb2xsUmVxdWVzdFpvbmVDaGFuZ2VkKHRoaXMuc2Nyb2xsRGlyZWN0aW9uQ2hhbmdlZCkucGlwZShcclxuICAgICAgdGFwKCgpID0+IHtcclxuICAgICAgICB0aGlzLnN0YXRlLnVwZGF0ZVByZXZpb3VzU2Nyb2xsVG9wKCk7XHJcbiAgICAgICAgdGhpcy5zdGF0ZS51cGRhdGVQcmV2aW91c1Njcm9sbEhlaWdodCgpO1xyXG4gICAgICAgIHRoaXMuc3RhdGUucHJldmlvdXNTY3JvbGxQb3NpdGlvbnBVcGRhdGVkID0gZmFsc2U7XHJcbiAgICAgICAgdGhpcy5zY3JvbGxIZWlnaHRMaXN0ZW5lci5zdGFydCgpO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSBlbDogRWxlbWVudFJlZixcclxuICAgIHByaXZhdGUgcmVuZGVyZXI6IFJlbmRlcmVyMixcclxuICAgIHByaXZhdGUgc3RhdGU6IERpcmVjdGl2ZVN0YXRlU2VydmljZVxyXG4gICkge1xyXG4gICAgc3VwZXIoKTtcclxuICAgIHRoaXMuc3RhdGUuc2V0dXAoe1xyXG4gICAgICBlbDogZWwsXHJcbiAgICAgIGluaXRNb2RlOiB0cnVlLFxyXG4gICAgICBzY3JvbGxTdHJlYW1BY3RpdmU6IHRydWUsXHJcbiAgICAgIHByZXZpb3VzU2Nyb2xsUG9zaXRpb25wVXBkYXRlZDogZmFsc2VcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIG5nT25Jbml0KCk6IHZvaWQge1xyXG4gICAgdGhpcy51c2VTdHJhdGVneSgpO1xyXG4gICAgdGhpcy51c2VTY3JvbGxIZWlnaHRMaXN0ZW5lcigpO1xyXG5cclxuICAgIHRoaXMucmVnaXN0ZXJTY3JvbGxFdmVudEhhbmRsZXIoKTtcclxuICAgIHRoaXMucmVnaXN0ZXJNdXRhdGlvbk9ic2VydmVyKCk7XHJcbiAgICB0aGlzLnJlZ2lzdGVySW5pdGlhbFNjcm9sbFBvc3Rpb25IYW5kbGVyKCk7XHJcbiAgICB0aGlzLnJlZ2lzdGVyUHJldmlvdXNTY3JvbGxQb3NpdGlvbkhhbmRsZXIoKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBuZ0FmdGVyVmlld0luaXQoKTogdm9pZCB7XHJcbiAgICB0aGlzLnJlZ2lzdGVyU2Nyb2xsU3B5KCk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgbmdPbkRlc3Ryb3koKTogdm9pZCB7XHJcbiAgICB0aGlzLmRvbU11dGF0aW9uT2JzZXJ2ZXIuZGlzY29ubmVjdCgpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHNjcm9sbFRvKHBvc2l0aW9uOiBudW1iZXIpOiB2b2lkIHtcclxuICAgIHRoaXMuc3RhdGUuc2Nyb2xsU3RyZWFtQWN0aXZlID0gZmFsc2U7XHJcbiAgICB0aGlzLnJlbmRlcmVyLnNldFByb3BlcnR5KHRoaXMuZWwubmF0aXZlRWxlbWVudCwgJ3Njcm9sbFRvcCcsIHBvc2l0aW9uKTtcclxuICAgIHRoaXMuc3RhdGUuc2Nyb2xsU3RyZWFtQWN0aXZlID0gdHJ1ZTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBvblNjcm9sbGJhckhlaWdodENoYW5nZWQoKTogdm9pZCB7XHJcbiAgICB0aGlzLnNjcm9sbEhlaWdodENoYW5nZWQubmV4dCgpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSByZWdpc3RlclNjcm9sbEV2ZW50SGFuZGxlcigpOiB2b2lkIHtcclxuICAgIHRoaXMuc2Nyb2xsQ2hhbmdlZCA9IGZyb21FdmVudCh0aGlzLmVsLm5hdGl2ZUVsZW1lbnQsICdzY3JvbGwnKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgcmVnaXN0ZXJNdXRhdGlvbk9ic2VydmVyKCk6IHZvaWQge1xyXG4gICAgdGhpcy5kb21NdXRhdGlvbk9ic2VydmVyID0gbmV3IE11dGF0aW9uT2JzZXJ2ZXIoXHJcbiAgICAgIChtdXRhdGlvbnM6IE11dGF0aW9uUmVjb3JkW10pID0+IHtcclxuICAgICAgICB0aGlzLmRvbU11dGF0aW9uRW1pdHRlci5uZXh0KG11dGF0aW9ucyk7XHJcbiAgICAgIH0pO1xyXG5cclxuICAgIGNvbnN0IGNvbmZpZyA9IHsgYXR0cmlidXRlczogdHJ1ZSwgY2hpbGRMaXN0OiB0cnVlLCBjaGFyYWN0ZXJEYXRhOiB0cnVlIH07XHJcbiAgICB0aGlzLmRvbU11dGF0aW9uT2JzZXJ2ZXIub2JzZXJ2ZSh0aGlzLmVsLm5hdGl2ZUVsZW1lbnQsIGNvbmZpZyk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHJlZ2lzdGVySW5pdGlhbFNjcm9sbFBvc3Rpb25IYW5kbGVyKCk6IHZvaWQge1xyXG4gICAgdGhpcy5kb21NdXRhdGlvbkVtaXR0ZXIucGlwZShcclxuICAgICAgdGFrZVdoaWxlKCgpID0+IHRoaXMuc3RhdGUuaW5pdE1vZGUpLFxyXG4gICAgICBkZWJvdW5jZVRpbWUodGhpcy5zY3JvbGxEZWJvdW5jZVRpbWVBZnRlckRPTU11dGF0aW9uT25Jbml0KVxyXG4gICAgKS5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICB0aGlzLnNjcm9sbGluZ1N0cmF0ZWd5LnNldEluaXRpYWxTY3JvbGxQb3NpdGlvbigpO1xyXG4gICAgICB0aGlzLnN0YXRlLmluaXRNb2RlID0gZmFsc2U7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgcmVnaXN0ZXJQcmV2aW91c1Njcm9sbFBvc2l0aW9uSGFuZGxlcigpOiB2b2lkIHtcclxuICAgIHppcChcclxuICAgICAgdGhpcy5zY3JvbGxSZXF1ZXN0Wm9uZUNoYW5nZWQsXHJcbiAgICAgIHRoaXMuc2Nyb2xsSGVpZ2h0Q2hhbmdlZFxyXG4gICAgKS5waXBlKFxyXG4gICAgICBza2lwV2hpbGUoKCkgPT4gdGhpcy5zdGF0ZS5pbml0TW9kZSksXHJcbiAgICAgIGRlYm91bmNlVGltZSh0aGlzLnNjcm9sbERlYm91bmNlVGltZUFmdGVyU2Nyb2xsSGVpZ2h0Q2hhbmdlZClcclxuICAgICkuc3Vic2NyaWJlKCgpID0+IHtcclxuICAgICAgdGhpcy5zY3JvbGxpbmdTdHJhdGVneS5zZXRQcmV2aW91c1Njcm9sbFBvc2l0aW9uKCk7XHJcbiAgICAgIHRoaXMuc3RhdGUucHJldmlvdXNTY3JvbGxQb3NpdGlvbnBVcGRhdGVkID0gdHJ1ZTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSByZWdpc3RlclNjcm9sbFNweSgpOiB2b2lkIHtcclxuICAgIHRoaXMuc2Nyb2xsUmVxdWVzdFpvbmVDaGFuZ2VkLnN1YnNjcmliZSgoKSA9PiB7XHJcbiAgICAgIHRoaXMuc2Nyb2xsaW5nU3RyYXRlZ3kuYXNrRm9yVXBkYXRlKCk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgdXNlU3RyYXRlZ3koKTogdm9pZCB7XHJcbiAgICBzd2l0Y2ggKHRoaXMuc3RyYXRlZ3kpIHtcclxuICAgICAgY2FzZSAnc2Nyb2xsaW5nVG9Cb3RoJzpcclxuICAgICAgICB0aGlzLnNjcm9sbGluZ1N0cmF0ZWd5ID0gbmV3IFNjcm9sbGluZ1RvQm90aCh0aGlzLCB0aGlzLnN0YXRlKTtcclxuICAgICAgICBicmVhaztcclxuICAgICAgY2FzZSAnc2Nyb2xsaW5nVG9Ub3AnOlxyXG4gICAgICAgIHRoaXMuc2Nyb2xsaW5nU3RyYXRlZ3kgPSBuZXcgU2Nyb2xsaW5nVG9Ub3AodGhpcywgdGhpcy5zdGF0ZSk7XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICAgIGNhc2UgJ3Njcm9sbGluZ1RvQm90dG9tJzogZGVmYXVsdDpcclxuICAgICAgICB0aGlzLnNjcm9sbGluZ1N0cmF0ZWd5ID0gbmV3IFNjcm9sbGluZ1RvQm90dG9tKHRoaXMsIHRoaXMuc3RhdGUpO1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSB1c2VTY3JvbGxIZWlnaHRMaXN0ZW5lcigpOiB2b2lkIHtcclxuICAgIHRoaXMuc2Nyb2xsSGVpZ2h0TGlzdGVuZXIgPSBuZXcgU2Nyb2xsSGVpZ2h0TGlzdGVuZXIodGhpcywgdGhpcy5zdGF0ZSk7XHJcbiAgfVxyXG59XHJcbiJdfQ==